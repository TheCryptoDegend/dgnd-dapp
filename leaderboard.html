<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DGND Holder Leaderboard</title>
  <style>
    body { font-family: Arial, sans-serif; background:#111; color:#f5f5f5; margin:0; padding:24px; }
    a { color:#ffd700; text-decoration:underline; }
    .wrap{ max-width:1100px; margin:0 auto; }
    .topbar{ display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; margin-bottom:12px; }
    .actions{ display:flex; gap:10px; flex-wrap:wrap; }
    input[type="text"]{
      background:#181818; color:#fff; border:1px solid #2a2a2a; border-radius:12px;
      padding:10px 12px; min-width:260px; outline:none;
    }
    button{
      padding:10px 14px; border:none; border-radius:12px; font-weight:700; cursor:pointer;
      background:linear-gradient(135deg,#22c55e,#2dd4bf); color:#04210e;
    }
    button.secondary{ background:#181818; color:#e5e5e5; border:1px solid #2a2a2a; }
    .meta{ color:#9cb0c2; font-size:14px; margin-bottom:10px; }
    .table-wrap{ overflow:auto; border-radius:12px; border:1px solid #333; background:#1a1a1a; }
    table{ width:100%; border-collapse:separate; border-spacing:0; min-width:720px; }
    thead th{
      background:#151515; color:#eaeaea; font-weight:700; font-size:14px;
      text-transform:uppercase; letter-spacing:.04em; text-align:left; padding:14px 16px;
      border-bottom:1px solid #2a2a2a;
    }
    tbody td{ padding:14px 16px; border-bottom:1px solid #2a2a2a; vertical-align:top; }
    tbody tr:last-child td{ border-bottom:none; }
    code { color:#0f0; }
    .me{ background:rgba(34,197,94,.08); }
    .me td{ border-bottom-color:rgba(34,197,94,.25); }
    .footer-actions{ display:flex; justify-content:center; margin-top:12px; }
    .note{ color:#9cb0c2; font-size:12px; margin-top:8px; }
    .back{ margin-bottom:16px; display:inline-block; }
  </style>
</head>
<body>
  <div class="wrap">
    <a class="back" href="./index.html">‚Üê Back to Dashboard</a>
    <h1>üèÜ DGND Holder Leaderboard</h1>

    <div class="topbar">
      <div class="actions">
        <input type="text" id="search" placeholder="Search address (0x‚Ä¶ or partial)"/>
        <button id="jump">Jump to my wallet</button>
        <button id="clear" class="secondary">Clear search</button>
      </div>
      <div class="meta" id="meta">Loading‚Ä¶</div>
    </div>

    <div class="table-wrap">
      <table aria-label="DGND Holder Leaderboard">
        <thead>
          <tr>
            <th style="width:90px">Rank</th>
            <th>Address</th>
            <th style="width:220px;text-align:right">Balance (DGND)</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="footer-actions">
      <button id="more">Show 50 more</button>
    </div>

    <div class="note">
      Data comes from your GitHub Action (Covalent ‚Üí <code>leaderboard.json</code>). The list is pre-sorted by balance (desc).
    </div>
  </div>

  <script>
    // ====== CONFIG ======
    // If this file and leaderboard.json live together (e.g., /docs on GitHub Pages):
    const LB_URL = './leaderboard.json';
    // If the JSON is at the site root, use: const LB_URL = '/leaderboard.json';

    const PAGE_SIZE = 50;
    let all = [];        // full dataset [{ address, balance }]
    let view = [];       // filtered list (for search)
    let cursor = 0;      // pagination cursor
    let myWallet = (localStorage.getItem('myWallet') || '').toLowerCase();

    // DOM
    const tbody  = document.getElementById('tbody');
    const meta   = document.getElementById('meta');
    const more   = document.getElementById('more');
    const search = document.getElementById('search');
    const jump   = document.getElementById('jump');
    const clear  = document.getElementById('clear');

    // Utils
    function fmtBalance(x){
      return Number(x).toLocaleString(undefined, { maximumFractionDigits: 6 });
    }
    function shortAddr(a){ return a ? (a.slice(0, 6) + '‚Ä¶' + a.slice(-4)) : '‚Äî'; }

    function explorerLinks(address){
      if (!/^0x[a-fA-F0-9]{40}$/.test(address)) return [];
      return [
        { name: 'Snowtrace', url: `https://snowtrace.io/address/${address}` },
        { name: 'Avascan',   url: `https://avascan.info/blockchain/c/address/${address}` }
      ];
    }

    function copyToClipboard(text){
      navigator.clipboard?.writeText(text).then(
        () => alert('Address copied to clipboard'),
        () => alert('Copy failed ‚Äî you can select the text manually.')
      );
    }

    function rowHTML(holder, rank, highlight){
      const addr = (holder?.address || '').toLowerCase();
      const bal  = Number(holder?.balance ?? 0);
      const links = explorerLinks(addr);
      const explorerHTML = links.length
        ? links.map(l => `<a href="${l.url}" target="_blank" rel="noopener">${l.name}</a>`).join(' ¬∑ ')
        : '<span style="opacity:.7">invalid address</span>';

      return `
        <tr class="${highlight ? 'me' : ''}" data-address="${addr}">
          <td>${rank}</td>
          <td>
            <code title="${addr}">${shortAddr(addr)}</code>
            <button
              style="margin-left:8px;padding:4px 8px;border:1px solid #2a2a2a;border-radius:8px;background:#181818;color:#e5e5e5;cursor:pointer"
              onclick="(${copyToClipboard.toString()})('${addr}')"
              aria-label="Copy address"
            >Copy</button>
            <div style="margin-top:6px">${explorerHTML}</div>
          </td>
          <td style="text-align:right">${fmtBalance(bal)}</td>
        </tr>
      `;
    }

    function updateMeta(updatedAt){
      const total = view.length;
      const shown = Math.min(cursor, total);
      const when  = updatedAt ? new Date(updatedAt).toLocaleString() : 'unknown';
      meta.textContent = `Showing ${shown} of ${total} holders ¬∑ Updated: ${when}`;
      more.style.display = shown >= total ? 'none' : 'inline-block';
    }

    function renderReset(){
      cursor = 0;
      tbody.innerHTML = '';
      updateMeta(window._lbUpdatedAt);
    }

    function renderMore(){
      const start = cursor;
      const end   = Math.min(cursor + PAGE_SIZE, view.length);
      let html = '';
      for (let i = start; i < end; i++){
        const h = view[i];
        const rank = i + 1;
        const isMe = myWallet && h.address.toLowerCase() === myWallet;
        html += rowHTML(h, rank, isMe);
      }
      tbody.insertAdjacentHTML('beforeend', html);
      cursor = end;
      updateMeta(window._lbUpdatedAt);
    }

    function applySearch(q){
      const s = (q || '').trim().toLowerCase();
      if (!s){
        view = all;
      } else {
        view = all.filter(h => (h.address || '').toLowerCase().includes(s));
      }
      renderReset();
      renderMore();
    }

    async function load(){
      try {
        const res = await fetch(LB_URL, { cache: 'no-store' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        // Expect { decimals, holders: [{address, balance}], updatedAt? }
        all = Array.isArray(data.holders) ? data.holders.filter(h => h && h.address) : [];
        // Sort desc by balance to be safe
        all.sort((a,b) => Number(b.balance||0) - Number(a.balance||0));
        window._lbUpdatedAt = data.updatedAt || null;

        view = all;
        renderReset();
        renderMore();
      } catch (e) {
        console.error(e);
        meta.textContent = 'Failed to load leaderboard. Serve over HTTP(S) and ensure LB_URL points to a valid JSON.';
      }
    }

    // Events
    search.addEventListener('input', (e) => applySearch(e.target.value));
    clear.addEventListener('click', () => { search.value=''; applySearch(''); });
    more.addEventListener('click', renderMore);

    jump.addEventListener('click', async () => {
      // If user typed a search address, prefer that; otherwise use myWallet
      const target = (search.value || myWallet || '').toLowerCase().trim();
      if (!/^0x[a-fA-F0-9]{40}$/.test(target)) {
        alert('No valid address to jump to (connect wallet on the dashboard or type a full 0x address in Search).');
        return;
      }
      // Find index in the full list
      const idx = all.findIndex(h => (h.address || '').toLowerCase() === target);
      if (idx < 0) { alert('Address not found in leaderboard.'); return; }

      // Ensure the row is rendered (paginate forward until includes idx)
      while (cursor <= idx) renderMore();

      // Highlight & scroll
      const row = tbody.querySelector(`tr[data-address="${target}"]`);
      if (row){
        row.classList.add('me');
        row.scrollIntoView({ behavior:'smooth', block:'center' });
      }
    });

    // Go!
    load();
  </script>
</body>
</html>
